<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GelfLogbackAppender.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">logstash logging connectors</a> &gt; <a href="index.source.html" class="el_package">biz.paluch.logging.gelf.logback</a> &gt; <span class="el_source">GelfLogbackAppender.java</span></div><h1>GelfLogbackAppender.java</h1><pre class="source lang-java linenums">package biz.paluch.logging.gelf.logback;

import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.LoggerName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.Marker;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.Severity;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.SourceClassName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.SourceLineNumber;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.SourceMethodName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.SourceSimpleClassName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.ThreadName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.Time;

import java.util.Collections;

import biz.paluch.logging.RuntimeContainer;
import biz.paluch.logging.gelf.LogMessageField;
import biz.paluch.logging.gelf.MdcGelfMessageAssembler;
import biz.paluch.logging.gelf.intern.Closer;
import biz.paluch.logging.gelf.intern.ConfigurationSupport;
import biz.paluch.logging.gelf.intern.ErrorReporter;
import biz.paluch.logging.gelf.intern.GelfMessage;
import biz.paluch.logging.gelf.intern.GelfSender;
import biz.paluch.logging.gelf.intern.GelfSenderFactory;
import ch.qos.logback.classic.spi.ILoggingEvent;
import ch.qos.logback.core.AppenderBase;

/**
 * Logging-Handler for GELF (Graylog Extended Logging Format). This Logback Handler creates GELF Messages and posts them using
 * UDP (default) or TCP. Following parameters are supported/needed:
 * &lt;ul&gt;
 * &lt;li&gt;host (Mandatory): Hostname/IP-Address of the Logstash Host
 * &lt;ul&gt;
 * &lt;li&gt;(the host) for UDP, e.g. 127.0.0.1 or some.host.com&lt;/li&gt;
 * &lt;li&gt;See docs for more details&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;/li&gt;
 * &lt;li&gt;port (Optional): Port, default 12201&lt;/li&gt;
 * &lt;li&gt;version (Optional): GELF Version 1.0 or 1.1, default 1.0&lt;/li&gt;
 * &lt;li&gt;originHost (Optional): Originating Hostname, default FQDN Hostname&lt;/li&gt;
 * &lt;li&gt;extractStackTrace (Optional): Post Stack-Trace to StackTrace field, default false&lt;/li&gt;
 * &lt;li&gt;filterStackTrace (Optional): Perform Stack-Trace filtering (true/false), default false&lt;/li&gt;
 * &lt;li&gt;mdcProfiling (Optional): Perform Profiling (Call-Duration) based on MDC Data. See &lt;a href=&quot;#mdcProfiling&quot;&gt;MDC
 * Profiling&lt;/a&gt;, default false&lt;/li&gt;
 * &lt;li&gt;facility (Optional): Name of the Facility, default gelf-java&lt;/li&gt;
 * &lt;li&gt;filter (Optional): logback filter (incl. log level)&lt;/li&gt;
 * &lt;li&gt;additionalFields(number) (Optional): Post additional fields. Eg.
 * .GelfLogHandler.additionalFields=fieldName=Value,field2=value2&lt;/li&gt;
 * &lt;li&gt;additionalFieldTypes (Optional): Type specification for additional and MDC fields. Supported types: String, long, Long,
 * double, Double and discover (default if not specified, discover field type on parseability). Eg. field=String,field2=double&lt;/li&gt;
 * &lt;li&gt;mdcFields (Optional): Post additional fields, pull Values from MDC. Name of the Fields are comma-separated
 * mdcFields=Application,Version,SomeOtherFieldName&lt;/li&gt;
 * &lt;li&gt;dynamicMdcFields (Optional): Dynamic MDC Fields allows you to extract MDC values based on one or more regular
 * expressions. Multiple regex are comma-separated. The name of the MDC entry is used as GELF field name.&lt;/li&gt;
 * &lt;li&gt;includeFullMdc (Optional): Include all fields from the MDC, default false&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;a name=&quot;mdcProfiling&quot;&gt;&lt;/a&gt; &lt;h2&gt;MDC Profiling&lt;/h2&gt;
 * &lt;p&gt;
 * MDC Profiling allows to calculate the runtime from request start up to the time until the log message was generated. You must
 * set one value in the MDC:
 * &lt;ul&gt;
 * &lt;li&gt;profiling.requestStart.millis: Time Millis of the Request-Start (Long or String)&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * Two values are set by the Log Appender:
 * &lt;/p&gt;
 * &lt;ul&gt;
 * &lt;li&gt;profiling.requestEnd: End-Time of the Request-End in Date.toString-representation&lt;/li&gt;
 * &lt;li&gt;profiling.requestDuration: Duration of the request (e.g. 205ms, 16sec)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * The {@link #append(ILoggingEvent)} method is thread-safe and may be called by different threads at any time.
 *
 * @author &lt;a href=&quot;mailto:tobiassebastian.kaefer@1und1.de&quot;&gt;Tobias Kaefer&lt;/a&gt;
 * @since 2013-10-08
 */
public class GelfLogbackAppender extends AppenderBase&lt;ILoggingEvent&gt; implements ErrorReporter {

    protected GelfSender gelfSender;
    protected MdcGelfMessageAssembler gelfMessageAssembler;

    public GelfLogbackAppender() {
<span class="fc" id="L82">        super();</span>
<span class="fc" id="L83">        gelfMessageAssembler = new MdcGelfMessageAssembler();</span>
<span class="fc" id="L84">        gelfMessageAssembler.addFields(LogMessageField.getDefaultMapping(Time, Severity, ThreadName, SourceClassName,</span>
                SourceMethodName, SourceLineNumber, SourceSimpleClassName, LoggerName, Marker));
<span class="fc" id="L86">    }</span>

    @Override
    protected void append(ILoggingEvent event) {

<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (event == null) {</span>
<span class="nc" id="L92">            return;</span>
        }

        try {
<span class="fc" id="L96">            GelfMessage message = createGelfMessage(event);</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">            if (!message.isValid()) {</span>
<span class="fc" id="L98">                reportError(&quot;GELF Message is invalid: &quot; + message.toJson(), null);</span>
<span class="fc" id="L99">                return;</span>
            }

<span class="pc bpc" id="L102" title="1 of 4 branches missed.">            if (null == gelfSender || !gelfSender.sendMessage(message)) {</span>
<span class="fc" id="L103">                reportError(&quot;Could not send GELF message&quot;, null);</span>
            }
<span class="nc" id="L105">        } catch (Exception e) {</span>
<span class="nc" id="L106">            reportError(&quot;Could not send GELF message: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L107">        }</span>
<span class="fc" id="L108">    }</span>

    @Override
    public void start() {

<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if (null == gelfSender) {</span>
<span class="fc" id="L114">            RuntimeContainer.initialize(this);</span>
<span class="fc" id="L115">            gelfSender = createGelfSender();</span>
        }

<span class="fc" id="L118">        super.start();</span>
<span class="fc" id="L119">    }</span>

    @Override
    public void stop() {

<span class="nc bnc" id="L124" title="All 2 branches missed.">        if(null != gelfSender) {</span>
<span class="nc" id="L125">            Closer.close(gelfSender);</span>
<span class="nc" id="L126">            gelfSender = null;</span>
        }

<span class="nc" id="L129">        super.stop();</span>
<span class="nc" id="L130">    }</span>

    protected GelfSender createGelfSender() {
<span class="fc" id="L133">        return GelfSenderFactory.createSender(gelfMessageAssembler, this, Collections.EMPTY_MAP);</span>
    }

    public void reportError(String message, Exception exception) {
<span class="fc" id="L137">        addError(message, exception);</span>
<span class="fc" id="L138">    }</span>

    protected GelfMessage createGelfMessage(final ILoggingEvent loggingEvent) {
<span class="fc" id="L141">        return gelfMessageAssembler.createGelfMessage(new LogbackLogEvent(loggingEvent));</span>
    }

    public void setAdditionalFields(String spec) {
<span class="fc" id="L145">        ConfigurationSupport.setAdditionalFields(spec, gelfMessageAssembler);</span>
<span class="fc" id="L146">    }</span>

    public void setAdditionalFieldTypes(String spec) {
<span class="fc" id="L149">        ConfigurationSupport.setAdditionalFieldTypes(spec, gelfMessageAssembler);</span>
<span class="fc" id="L150">    }</span>

    public void setMdcFields(String spec) {
<span class="fc" id="L153">        ConfigurationSupport.setMdcFields(spec, gelfMessageAssembler);</span>
<span class="fc" id="L154">    }</span>

    public void setDynamicMdcFields(String spec) {
<span class="fc" id="L157">        ConfigurationSupport.setDynamicMdcFields(spec, gelfMessageAssembler);</span>
<span class="fc" id="L158">    }</span>

    public String getGraylogHost() {
<span class="fc" id="L161">        return gelfMessageAssembler.getHost();</span>
    }

    public void setGraylogHost(String graylogHost) {
<span class="fc" id="L165">        gelfMessageAssembler.setHost(graylogHost);</span>
<span class="fc" id="L166">    }</span>

    public String getOriginHost() {
<span class="fc" id="L169">        return gelfMessageAssembler.getOriginHost();</span>
    }

    public void setOriginHost(String originHost) {
<span class="fc" id="L173">        gelfMessageAssembler.setOriginHost(originHost);</span>
<span class="fc" id="L174">    }</span>

    public int getGraylogPort() {
<span class="fc" id="L177">        return gelfMessageAssembler.getPort();</span>
    }

    public void setGraylogPort(int graylogPort) {
<span class="fc" id="L181">        gelfMessageAssembler.setPort(graylogPort);</span>
<span class="fc" id="L182">    }</span>

    public String getHost() {
<span class="fc" id="L185">        return gelfMessageAssembler.getHost();</span>
    }

    public void setHost(String host) {
<span class="nc" id="L189">        gelfMessageAssembler.setHost(host);</span>
<span class="nc" id="L190">    }</span>

    public int getPort() {
<span class="fc" id="L193">        return gelfMessageAssembler.getPort();</span>
    }

    public void setPort(int port) {
<span class="nc" id="L197">        gelfMessageAssembler.setPort(port);</span>
<span class="nc" id="L198">    }</span>

    public String getFacility() {
<span class="fc" id="L201">        return gelfMessageAssembler.getFacility();</span>
    }

    public void setFacility(String facility) {
<span class="fc" id="L205">        gelfMessageAssembler.setFacility(facility);</span>
<span class="fc" id="L206">    }</span>

    public boolean isExtractStackTrace() {
<span class="fc" id="L209">        return gelfMessageAssembler.isExtractStackTrace();</span>
    }

    public void setExtractStackTrace(boolean extractStacktrace) {
<span class="fc" id="L213">        gelfMessageAssembler.setExtractStackTrace(extractStacktrace);</span>
<span class="fc" id="L214">    }</span>

    public boolean isFilterStackTrace() {
<span class="fc" id="L217">        return gelfMessageAssembler.isFilterStackTrace();</span>
    }

    public void setFilterStackTrace(boolean filterStackTrace) {
<span class="fc" id="L221">        gelfMessageAssembler.setFilterStackTrace(filterStackTrace);</span>
<span class="fc" id="L222">    }</span>

    public boolean isMdcProfiling() {
<span class="fc" id="L225">        return gelfMessageAssembler.isMdcProfiling();</span>
    }

    public void setMdcProfiling(boolean mdcProfiling) {
<span class="fc" id="L229">        gelfMessageAssembler.setMdcProfiling(mdcProfiling);</span>
<span class="fc" id="L230">    }</span>

    public String getTimestampPattern() {
<span class="fc" id="L233">        return gelfMessageAssembler.getTimestampPattern();</span>
    }

    public void setTimestampPattern(String timestampPattern) {
<span class="fc" id="L237">        gelfMessageAssembler.setTimestampPattern(timestampPattern);</span>
<span class="fc" id="L238">    }</span>

    public int getMaximumMessageSize() {
<span class="fc" id="L241">        return gelfMessageAssembler.getMaximumMessageSize();</span>
    }

    public void setMaximumMessageSize(int maximumMessageSize) {
<span class="fc" id="L245">        gelfMessageAssembler.setMaximumMessageSize(maximumMessageSize);</span>
<span class="fc" id="L246">    }</span>

    public boolean isIncludeFullMdc() {
<span class="fc" id="L249">        return gelfMessageAssembler.isIncludeFullMdc();</span>
    }

    public void setIncludeFullMdc(boolean includeFullMdc) {
<span class="fc" id="L253">        gelfMessageAssembler.setIncludeFullMdc(includeFullMdc);</span>
<span class="fc" id="L254">    }</span>

    public String getVersion() {
<span class="nc" id="L257">        return gelfMessageAssembler.getVersion();</span>
    }

    public void setVersion(String version) {
<span class="fc" id="L261">        gelfMessageAssembler.setVersion(version);</span>
<span class="fc" id="L262">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>