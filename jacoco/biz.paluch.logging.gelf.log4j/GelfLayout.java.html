<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GelfLayout.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">logstash logging connectors</a> &gt; <a href="index.source.html" class="el_package">biz.paluch.logging.gelf.log4j</a> &gt; <span class="el_source">GelfLayout.java</span></div><h1>GelfLayout.java</h1><pre class="source lang-java linenums">package biz.paluch.logging.gelf.log4j;

import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.*;

import java.util.*;

import org.apache.log4j.Layout;
import org.apache.log4j.spi.LoggingEvent;

import biz.paluch.logging.gelf.LogMessageField;
import biz.paluch.logging.gelf.MdcGelfMessageAssembler;
import biz.paluch.logging.gelf.intern.ConfigurationSupport;
import biz.paluch.logging.gelf.intern.GelfMessage;

/**
 * Log-Formatter for JSON using fields specified within GELF. This formatter will produce a JSON object for each log event.
 * Example:
 *
 * &lt;code&gt;
 {
    &quot;NDC&quot;: &quot;ndc message&quot;,
    &quot;timestamp&quot;: &quot;1439319236.722&quot;,
    &quot;SourceClassName&quot;: &quot;biz.paluch.logging.gelf.wildfly.WildFlyGelfLogFormatterTest&quot;,
    &quot;SourceMethodName&quot;: &quot;testDefaults&quot;,
    &quot;level&quot;: &quot;6&quot;,
    &quot;SourceSimpleClassName&quot;: &quot;WildFlyGelfLogFormatterTest&quot;,
    &quot;facility&quot;: &quot;logstash-gelf&quot;,
    &quot;full_message&quot;: &quot;foo bar test log message&quot;,
    &quot;short_message&quot;: &quot;foo bar test log message&quot;,
    &quot;MySeverity&quot;: &quot;INFO&quot;,
    &quot;LoggerName&quot;: &quot;biz.paluch.logging.gelf.wildfly.WildFlyGelfLogFormatterTest&quot;,
    &quot;Thread&quot;: &quot;main&quot;,
    &quot;MyTime&quot;: &quot;2015-08-11 20:53:56,0722&quot;
}
 * &lt;/code&gt;
 *
 * Following parameters are supported/needed:
 * &lt;ul&gt;
 * &lt;li&gt;lineBreak (Optional): End of line, platform dependent default value, see {@code System.getProperty(&quot;line.separator&quot;)}&lt;/li&gt;
 * &lt;li&gt;fields (Optional): Comma-separated list of log event fields that should be included in the JSON. Defaults to
 * {@code Time, Severity, ThreadName, SourceClassName, SourceMethodName, SourceSimpleClassName, LoggerName, NDC}&lt;/li&gt;
 * &lt;li&gt;originHost (Optional): Originating Hostname, default FQDN Hostname&lt;/li&gt;
 * &lt;li&gt;extractStackTrace (Optional): Post Stack-Trace to StackTrace field (true/false/throwable reference [0 = throwable, 1 =
 * throwable.cause, -1 = root cause]), default false&lt;/li&gt;
 * &lt;li&gt;filterStackTrace (Optional): Perform Stack-Trace filtering (true/false), default false&lt;/li&gt;
 * &lt;li&gt;includeLocation (Optional): Include source code location, default true&lt;/li&gt;
 * &lt;li&gt;mdcProfiling (Optional): Perform Profiling (Call-Duration) based on MDC Data. See &lt;a href=&quot;#mdcProfiling&quot;&gt;MDC
 * Profiling&lt;/a&gt;, default false&lt;/li&gt;
 * &lt;li&gt;facility (Optional): Name of the Facility, default gelf-java&lt;/li&gt;
 * &lt;li&gt;additionalFields(number) (Optional): Post additional fields. Eg. fieldName=Value,field2=value2&lt;/li&gt;
 * &lt;li&gt;additionalFieldTypes (Optional): Type specification for additional and MDC fields. Supported types: String, long, Long,
 * double, Double and discover (default if not specified, discover field type on parseability). Eg. field=String,field2=double&lt;/li&gt;
 * &lt;li&gt;mdcFields (Optional): Post additional fields, pull Values from MDC. Name of the Fields are comma-separated
 * Application,Version,SomeOtherFieldName&lt;/li&gt;
 * &lt;li&gt;dynamicMdcFields (Optional): Dynamic MDC Fields allows you to extract MDC values based on one or more regular
 * expressions. Multiple regex are comma-separated. The name of the MDC entry is used as GELF field name. mdc.*,[mdc|MDC]fields&lt;/li&gt;
 * &lt;li&gt;includeFullMdc (Optional): Include all fields from the MDC, default false&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;a name=&quot;mdcProfiling&quot;&gt;&lt;/a&gt; &lt;h2&gt;MDC Profiling&lt;/h2&gt;
 * &lt;p&gt;
 * MDC Profiling allows to calculate the runtime from request start up to the time until the log message was generated. You must
 * set one value in the MDC:
 * &lt;ul&gt;
 * &lt;li&gt;profiling.requestStart.millis: Time Millis of the Request-Start (Long or String)&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * Two values are set by the formatter:
 * &lt;/p&gt;
 * &lt;ul&gt;
 * &lt;li&gt;profiling.requestEnd: End-Time of the Request-End in Date.toString-representation&lt;/li&gt;
 * &lt;li&gt;profiling.requestDuration: Duration of the request (e.g. 205ms, 16sec)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @author &lt;a href=&quot;mailto:kai.geisselhardt@kaufland.com&quot;&gt;Kai Geisselhardt&lt;/a&gt;
 * @author Mark Paluch
 */
public class GelfLayout extends Layout {

    public static final String MULTI_VALUE_DELIMITTER = &quot;,&quot;;
    public static final Set&lt;LogMessageField.NamedLogField&gt; SUPPORTED_FIELDS;

<span class="fc" id="L82">    private final MdcGelfMessageAssembler gelfMessageAssembler = new MdcGelfMessageAssembler();</span>
<span class="fc" id="L83">    private String lineBreak = Layout.LINE_SEP;</span>
<span class="fc" id="L84">    private boolean wasSetFieldsCalled = false;</span>

    static {
<span class="fc" id="L87">        Set&lt;LogMessageField.NamedLogField&gt; supportedFields = new LinkedHashSet&lt;LogMessageField.NamedLogField&gt;();</span>

<span class="fc" id="L89">        supportedFields.add(Time);</span>
<span class="fc" id="L90">        supportedFields.add(Severity);</span>
<span class="fc" id="L91">        supportedFields.add(ThreadName);</span>
<span class="fc" id="L92">        supportedFields.add(SourceClassName);</span>
<span class="fc" id="L93">        supportedFields.add(SourceMethodName);</span>
<span class="fc" id="L94">        supportedFields.add(SourceLineNumber);</span>
<span class="fc" id="L95">        supportedFields.add(SourceSimpleClassName);</span>
<span class="fc" id="L96">        supportedFields.add(LoggerName);</span>
<span class="fc" id="L97">        supportedFields.add(NDC);</span>
<span class="fc" id="L98">        supportedFields.add(Server);</span>

<span class="fc" id="L100">        SUPPORTED_FIELDS = Collections.unmodifiableSet(supportedFields);</span>
<span class="fc" id="L101">    }</span>

    public GelfLayout() {
<span class="fc" id="L104">        super();</span>
<span class="fc" id="L105">    }</span>

    @Override
    public String format(LoggingEvent loggingEvent) {
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (!wasSetFieldsCalled) {</span>
<span class="fc" id="L110">            addFields(SUPPORTED_FIELDS);</span>
        }
<span class="fc" id="L112">        GelfMessage gelfMessage = gelfMessageAssembler.createGelfMessage(new Log4jLogEvent(loggingEvent));</span>
<span class="fc" id="L113">        return gelfMessage.toJson(&quot;&quot;) + lineBreak;</span>
    }

    @Override
    public boolean ignoresThrowable() {
<span class="fc" id="L118">        return false;</span>
    }

    @Override
    public void activateOptions() {

<span class="fc" id="L124">    }</span>

    public void setFields(String fieldSpec) {

<span class="fc" id="L128">        String[] properties = fieldSpec.split(MULTI_VALUE_DELIMITTER);</span>
<span class="fc" id="L129">        List&lt;LogMessageField.NamedLogField&gt; fields = new ArrayList&lt;LogMessageField.NamedLogField&gt;();</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        for (String field : properties) {</span>

<span class="fc" id="L132">            LogMessageField.NamedLogField namedLogField = LogMessageField.NamedLogField.byName(field.trim());</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            if (namedLogField == null) {</span>
<span class="nc" id="L134">                throw new IllegalArgumentException(&quot;Cannot resolve field name '&quot; + field</span>
                        + &quot;' to a field. Supported field names are: &quot; + SUPPORTED_FIELDS);
            }

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">            if (!SUPPORTED_FIELDS.contains(namedLogField)) {</span>
<span class="nc" id="L139">                throw new IllegalArgumentException(&quot;Field '&quot; + field + &quot;' is not supported. Supported field names are: &quot;</span>
                        + SUPPORTED_FIELDS);
            }

<span class="fc" id="L143">            fields.add(namedLogField);</span>
        }

<span class="fc" id="L146">        addFields(fields);</span>

<span class="fc" id="L148">    }</span>

    private void addFields(Collection&lt;LogMessageField.NamedLogField&gt; fields) {
<span class="fc" id="L151">        gelfMessageAssembler.addFields(LogMessageField.getDefaultMapping(fields</span>
<span class="fc" id="L152">                .toArray(new LogMessageField.NamedLogField[fields.size()])));</span>

<span class="fc" id="L154">        wasSetFieldsCalled = true;</span>
<span class="fc" id="L155">    }</span>

    public void setAdditionalFields(String spec) {
<span class="fc" id="L158">        ConfigurationSupport.setAdditionalFields(spec, gelfMessageAssembler);</span>
<span class="fc" id="L159">    }</span>

    public void setAdditionalFieldTypes(String spec) {
<span class="nc" id="L162">        ConfigurationSupport.setAdditionalFieldTypes(spec, gelfMessageAssembler);</span>
<span class="nc" id="L163">    }</span>

    public void setMdcFields(String spec) {
<span class="fc" id="L166">        ConfigurationSupport.setMdcFields(spec, gelfMessageAssembler);</span>
<span class="fc" id="L167">    }</span>

    public void setDynamicMdcFields(String spec) {
<span class="nc" id="L170">        ConfigurationSupport.setDynamicMdcFields(spec, gelfMessageAssembler);</span>
<span class="nc" id="L171">    }</span>

    public boolean isMdcProfiling() {
<span class="nc" id="L174">        return gelfMessageAssembler.isMdcProfiling();</span>
    }

    public void setMdcProfiling(boolean mdcProfiling) {
<span class="fc" id="L178">        gelfMessageAssembler.setMdcProfiling(mdcProfiling);</span>
<span class="fc" id="L179">    }</span>

    public boolean isIncludeFullMdc() {
<span class="nc" id="L182">        return gelfMessageAssembler.isIncludeFullMdc();</span>
    }

    public void setIncludeFullMdc(boolean includeFullMdc) {
<span class="fc" id="L186">        gelfMessageAssembler.setIncludeFullMdc(includeFullMdc);</span>
<span class="fc" id="L187">    }</span>

    public String getOriginHost() {
<span class="nc" id="L190">        return gelfMessageAssembler.getOriginHost();</span>
    }

    public void setOriginHost(String originHost) {
<span class="fc" id="L194">        gelfMessageAssembler.setOriginHost(originHost);</span>
<span class="fc" id="L195">    }</span>

    public String getFacility() {
<span class="nc" id="L198">        return gelfMessageAssembler.getFacility();</span>
    }

    public void setFacility(String facility) {
<span class="fc" id="L202">        gelfMessageAssembler.setFacility(facility);</span>
<span class="fc" id="L203">    }</span>

    public String getExtractStackTrace() {
<span class="nc" id="L206">        return gelfMessageAssembler.getExtractStackTrace();</span>
    }

    public void setExtractStackTrace(String extractStacktrace) {
<span class="fc" id="L210">        gelfMessageAssembler.setExtractStackTrace(extractStacktrace);</span>
<span class="fc" id="L211">    }</span>

    public boolean isFilterStackTrace() {
<span class="nc" id="L214">        return gelfMessageAssembler.isFilterStackTrace();</span>
    }

    public void setFilterStackTrace(boolean filterStackTrace) {
<span class="fc" id="L218">        gelfMessageAssembler.setFilterStackTrace(filterStackTrace);</span>
<span class="fc" id="L219">    }</span>

    public boolean isIncludeLocation() {
<span class="nc" id="L222">        return gelfMessageAssembler.isIncludeLocation();</span>
    }

    public void setIncludeLocation(boolean includeLocation) {
<span class="fc" id="L226">        gelfMessageAssembler.setIncludeLocation(includeLocation);</span>
<span class="fc" id="L227">    }</span>

    public String getTimestampPattern() {
<span class="nc" id="L230">        return gelfMessageAssembler.getTimestampPattern();</span>
    }

    public void setTimestampPattern(String timestampPattern) {
<span class="nc" id="L234">        gelfMessageAssembler.setTimestampPattern(timestampPattern);</span>
<span class="nc" id="L235">    }</span>

    public String getVersion() {
<span class="nc" id="L238">        return gelfMessageAssembler.getVersion();</span>
    }

    public void setVersion(String version) {
<span class="nc" id="L242">        gelfMessageAssembler.setVersion(version);</span>
<span class="nc" id="L243">    }</span>

    public String getLineBreak() {
<span class="nc" id="L246">        return lineBreak;</span>
    }

    public void setLineBreak(String lineBreak) {
<span class="nc" id="L250">        this.lineBreak = lineBreak;</span>
<span class="nc" id="L251">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>