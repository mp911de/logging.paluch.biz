<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WildFlyJsonFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">logstash logging connectors</a> &gt; <a href="index.source.html" class="el_package">biz.paluch.logging.gelf.wildfly</a> &gt; <span class="el_source">WildFlyJsonFormatter.java</span></div><h1>WildFlyJsonFormatter.java</h1><pre class="source lang-java linenums">package biz.paluch.logging.gelf.wildfly;

import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.LoggerName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.NDC;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.Server;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.Severity;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.SourceClassName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.SourceMethodName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.SourceSimpleClassName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.ThreadName;
import static biz.paluch.logging.gelf.LogMessageField.NamedLogField.Time;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Set;

import org.jboss.logmanager.ExtFormatter;
import org.jboss.logmanager.ExtLogRecord;

import biz.paluch.logging.gelf.LogMessageField;
import biz.paluch.logging.gelf.MdcGelfMessageAssembler;
import biz.paluch.logging.gelf.intern.ConfigurationSupport;
import biz.paluch.logging.gelf.intern.GelfMessage;
import biz.paluch.logging.gelf.jboss7.JBoss7JulLogEvent;

/**
 * Log-Formatter for JSON using fields specified within GELF. This formatter will produce a JSON object for each log event.
 * Example:
 *
 * &lt;code&gt;
 {
    &quot;NDC&quot;: &quot;ndc message&quot;,
    &quot;timestamp&quot;: &quot;1439319236.722&quot;,
    &quot;SourceClassName&quot;: &quot;biz.paluch.logging.gelf.wildfly.WildFlyGelfLogFormatterTest&quot;,
    &quot;SourceMethodName&quot;: &quot;testDefaults&quot;,
    &quot;level&quot;: &quot;6&quot;,
    &quot;SourceSimpleClassName&quot;: &quot;WildFlyGelfLogFormatterTest&quot;,
    &quot;facility&quot;: &quot;logstash-gelf&quot;,
    &quot;full_message&quot;: &quot;foo bar test log message&quot;,
    &quot;short_message&quot;: &quot;foo bar test log message&quot;,
    &quot;MySeverity&quot;: &quot;INFO&quot;,
    &quot;LoggerName&quot;: &quot;biz.paluch.logging.gelf.wildfly.WildFlyGelfLogFormatterTest&quot;,
    &quot;Thread&quot;: &quot;main&quot;,
    &quot;MyTime&quot;: &quot;2015-08-11 20:53:56,0722&quot;
}
 * &lt;/code&gt;
 *
 * Following parameters are supported/needed:
 * &lt;ul&gt;
 * &lt;li&gt;lineBreak (Optional): End of line, defaults to {@code \n}&lt;/li&gt;
 * &lt;li&gt;fields (Optional): Comma-separated list of log event fields that should be included in the JSON. Defaults to
 * {@code Time, Severity, ThreadName, SourceClassName, SourceMethodName, SourceSimpleClassName, LoggerName, NDC}&lt;/li&gt;
 * &lt;li&gt;originHost (Optional): Originating Hostname, default FQDN Hostname&lt;/li&gt;
 * &lt;li&gt;extractStackTrace (Optional): Post Stack-Trace to StackTrace field (true/false/throwable reference [0 = throwable, 1 = throwable.cause, -1 = root cause]), default false&lt;/li&gt;
 * &lt;li&gt;filterStackTrace (Optional): Perform Stack-Trace filtering (true/false), default false&lt;/li&gt;
 * &lt;li&gt;mdcProfiling (Optional): Perform Profiling (Call-Duration) based on MDC Data. See &lt;a href=&quot;#mdcProfiling&quot;&gt;MDC
 * Profiling&lt;/a&gt;, default false&lt;/li&gt;
 * &lt;li&gt;facility (Optional): Name of the Facility, default gelf-java&lt;/li&gt;
 * &lt;li&gt;additionalFields(number) (Optional): Post additional fields. Eg. fieldName=Value,field2=value2&lt;/li&gt;
 * &lt;li&gt;additionalFieldTypes (Optional): Type specification for additional and MDC fields. Supported types: String, long, Long,
 * double, Double and discover (default if not specified, discover field type on parseability). Eg. field=String,field2=double&lt;/li&gt;
 * &lt;li&gt;mdcFields (Optional): Post additional fields, pull Values from MDC. Name of the Fields are comma-separated
 * Application,Version,SomeOtherFieldName&lt;/li&gt;
 * &lt;li&gt;dynamicMdcFields (Optional): Dynamic MDC Fields allows you to extract MDC values based on one or more regular
 * expressions. Multiple regex are comma-separated. The name of the MDC entry is used as GELF field name. mdc.*,[mdc|MDC]fields&lt;/li&gt;
 * &lt;li&gt;includeFullMdc (Optional): Include all fields from the MDC, default false&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;a name=&quot;mdcProfiling&quot;&gt;&lt;/a&gt; &lt;h2&gt;MDC Profiling&lt;/h2&gt;
 * &lt;p&gt;
 * MDC Profiling allows to calculate the runtime from request start up to the time until the log message was generated. You must
 * set one value in the MDC:
 * &lt;ul&gt;
 * &lt;li&gt;profiling.requestStart.millis: Time Millis of the Request-Start (Long or String)&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * Two values are set by the formatter:
 * &lt;/p&gt;
 * &lt;ul&gt;
 * &lt;li&gt;profiling.requestEnd: End-Time of the Request-End in Date.toString-representation&lt;/li&gt;
 * &lt;li&gt;profiling.requestDuration: Duration of the request (e.g. 205ms, 16sec)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @author Mark Paluch
 */
public class WildFlyJsonFormatter extends ExtFormatter {

    public static final String MULTI_VALUE_DELIMITTER = &quot;,&quot;;
<span class="fc" id="L91">    private MdcGelfMessageAssembler gelfMessageAssembler = new MdcGelfMessageAssembler();</span>
<span class="fc" id="L92">    private String lineBreak = &quot;\n&quot;;</span>
<span class="fc" id="L93">    private boolean wasSetFieldsCalled = false;</span>

    public static final Set&lt;LogMessageField.NamedLogField&gt; SUPPORTED_FIELDS;

    static {
<span class="fc" id="L98">        Set&lt;LogMessageField.NamedLogField&gt; supportedFields = new LinkedHashSet&lt;LogMessageField.NamedLogField&gt;();</span>

<span class="fc" id="L100">        supportedFields.add(Time);</span>
<span class="fc" id="L101">        supportedFields.add(Severity);</span>
<span class="fc" id="L102">        supportedFields.add(ThreadName);</span>
<span class="fc" id="L103">        supportedFields.add(SourceClassName);</span>
<span class="fc" id="L104">        supportedFields.add(SourceMethodName);</span>
<span class="fc" id="L105">        supportedFields.add(SourceSimpleClassName);</span>
<span class="fc" id="L106">        supportedFields.add(LoggerName);</span>
<span class="fc" id="L107">        supportedFields.add(NDC);</span>
<span class="fc" id="L108">        supportedFields.add(Server);</span>

<span class="fc" id="L110">        SUPPORTED_FIELDS = Collections.unmodifiableSet(supportedFields);</span>
<span class="fc" id="L111">    }</span>

    /**
     * Create a new instance of the {@link WildFlyJsonFormatter}.
     */
<span class="fc" id="L116">    public WildFlyJsonFormatter() {</span>

<span class="fc" id="L118">    }</span>

    @Override
    public String format(ExtLogRecord extLogRecord) {
<span class="fc bfc" id="L122" title="All 2 branches covered.">        if (!wasSetFieldsCalled) {</span>
<span class="fc" id="L123">            addFields(SUPPORTED_FIELDS);</span>
        }

<span class="fc" id="L126">        GelfMessage gelfMessage = gelfMessageAssembler.createGelfMessage(new JBoss7JulLogEvent(extLogRecord));</span>
<span class="fc" id="L127">        return gelfMessage.toJson(&quot;&quot;) + getLineBreak();</span>
    }

    public void setFields(String fieldSpec) {

<span class="fc" id="L132">        String[] properties = fieldSpec.split(MULTI_VALUE_DELIMITTER);</span>
<span class="fc" id="L133">        List&lt;LogMessageField.NamedLogField&gt; fields = new ArrayList&lt;LogMessageField.NamedLogField&gt;();</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        for (String field : properties) {</span>

<span class="fc" id="L136">            LogMessageField.NamedLogField namedLogField = LogMessageField.NamedLogField.byName(field.trim());</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            if (namedLogField == null) {</span>
<span class="fc" id="L138">                throw new IllegalArgumentException(&quot;Cannot resolve field name '&quot; + field</span>
                        + &quot;' to a field. Supported field names are: &quot; + SUPPORTED_FIELDS);
            }

<span class="fc bfc" id="L142" title="All 2 branches covered.">            if (!SUPPORTED_FIELDS.contains(namedLogField)) {</span>
<span class="fc" id="L143">                throw new IllegalArgumentException(&quot;Field '&quot; + field + &quot;' is not supported. Supported field names are: &quot;</span>
                        + SUPPORTED_FIELDS);
            }

<span class="fc" id="L147">            fields.add(namedLogField);</span>
        }

<span class="fc" id="L150">        addFields(fields);</span>

<span class="fc" id="L152">    }</span>

    private void addFields(Collection&lt;LogMessageField.NamedLogField&gt; fields) {
<span class="fc" id="L155">        gelfMessageAssembler.addFields(LogMessageField.getDefaultMapping(fields</span>
<span class="fc" id="L156">                .toArray(new LogMessageField.NamedLogField[fields.size()])));</span>

<span class="fc" id="L158">        wasSetFieldsCalled = true;</span>
<span class="fc" id="L159">    }</span>

    public void setAdditionalFields(String spec) {
<span class="fc" id="L162">        ConfigurationSupport.setAdditionalFields(spec, gelfMessageAssembler);</span>
<span class="fc" id="L163">    }</span>

    public void setAdditionalFieldTypes(String spec) {
<span class="nc" id="L166">        ConfigurationSupport.setAdditionalFieldTypes(spec, gelfMessageAssembler);</span>
<span class="nc" id="L167">    }</span>

    public void setMdcFields(String spec) {
<span class="nc" id="L170">        ConfigurationSupport.setMdcFields(spec, gelfMessageAssembler);</span>
<span class="nc" id="L171">    }</span>

    public void setDynamicMdcFields(String spec) {
<span class="fc" id="L174">        ConfigurationSupport.setDynamicMdcFields(spec, gelfMessageAssembler);</span>
<span class="fc" id="L175">    }</span>

    public boolean isMdcProfiling() {
<span class="nc" id="L178">        return gelfMessageAssembler.isMdcProfiling();</span>
    }

    public void setMdcProfiling(boolean mdcProfiling) {
<span class="nc" id="L182">        gelfMessageAssembler.setMdcProfiling(mdcProfiling);</span>
<span class="nc" id="L183">    }</span>

    public boolean isIncludeFullMdc() {
<span class="nc" id="L186">        return gelfMessageAssembler.isIncludeFullMdc();</span>
    }

    public void setIncludeFullMdc(boolean includeFullMdc) {
<span class="fc" id="L190">        gelfMessageAssembler.setIncludeFullMdc(includeFullMdc);</span>
<span class="fc" id="L191">    }</span>

    public String getOriginHost() {
<span class="nc" id="L194">        return gelfMessageAssembler.getOriginHost();</span>
    }

    public void setOriginHost(String originHost) {
<span class="fc" id="L198">        gelfMessageAssembler.setOriginHost(originHost);</span>
<span class="fc" id="L199">    }</span>

    public String getFacility() {
<span class="nc" id="L202">        return gelfMessageAssembler.getFacility();</span>
    }

    public void setFacility(String facility) {
<span class="nc" id="L206">        gelfMessageAssembler.setFacility(facility);</span>
<span class="nc" id="L207">    }</span>

    public String getExtractStackTrace() {
<span class="nc" id="L210">        return gelfMessageAssembler.getExtractStackTrace();</span>
    }

    public void setExtractStackTrace(String extractStacktrace) {
<span class="fc" id="L214">        gelfMessageAssembler.setExtractStackTrace(extractStacktrace);</span>
<span class="fc" id="L215">    }</span>

    public boolean isFilterStackTrace() {
<span class="nc" id="L218">        return gelfMessageAssembler.isFilterStackTrace();</span>
    }

    public void setFilterStackTrace(boolean filterStackTrace) {
<span class="nc" id="L222">        gelfMessageAssembler.setFilterStackTrace(filterStackTrace);</span>
<span class="nc" id="L223">    }</span>

    public String getTimestampPattern() {
<span class="nc" id="L226">        return gelfMessageAssembler.getTimestampPattern();</span>
    }

    public void setTimestampPattern(String timestampPattern) {
<span class="nc" id="L230">        gelfMessageAssembler.setTimestampPattern(timestampPattern);</span>
<span class="nc" id="L231">    }</span>

    public String getVersion() {
<span class="nc" id="L234">        return gelfMessageAssembler.getVersion();</span>
    }

    public void setVersion(String version) {
<span class="nc" id="L238">        gelfMessageAssembler.setVersion(version);</span>
<span class="nc" id="L239">    }</span>

    public String getLineBreak() {
<span class="fc" id="L242">        return lineBreak;</span>
    }

    public void setLineBreak(String lineBreak) {
<span class="fc" id="L246">        this.lineBreak = lineBreak;</span>
<span class="fc" id="L247">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>